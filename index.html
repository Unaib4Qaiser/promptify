<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Prompt Manager</title>
    <meta name="theme-color" content="#4A9782"/>
    <!-- PWA manifest and icon links will be injected by JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <style>
        /* Custom Theme Colors */
        :root {
            --bg-main: #FFF9E5;
            --bg-card: #DCD0A8;
            --accent-primary: #4A9782;
            --text-main: #004030;
            --accent-secondary: #004030; /* Using dark green for secondary accents */
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-main);
            color: var(--text-main);
        }
        .main-heading {
            font-family: 'Playfair Display', serif;
        }
        .color-dot {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            transition: transform 0.2s ease;
            border: 2px solid transparent;
        }
        .color-dot.selected {
            border-color: var(--text-main);
            transform: scale(1.2);
        }
        .prompt-card {
            border-left-width: 5px;
            background-color: var(--bg-card);
            min-height: 200px; /* Set a min-height for grid consistency */
            box-shadow: 0 4px 12px rgba(0,0,0,0.08);
            transition: all 0.2s ease-in-out;
        }
        .prompt-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 16px rgba(0,0,0,0.12);
        }
        .prompt-text {
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 4; /* Adjust the number of lines to show */
            -webkit-box-orient: vertical;
            color: var(--text-main);
        }
        /* New Category Colors */
        .color-red { border-color: #E57373; }
        .color-blue { border-color: #64B5F6; }
        .color-green { border-color: #81C784; }
        .color-yellow { border-color: #FFD54F; }
        .color-purple { border-color: #BA68C8; }

        .dot-red { background-color: #E57373; }
        .dot-blue { background-color: #64B5F6; }
        .dot-green { background-color: #81C784; }
        .dot-yellow { background-color: #FFD54F; }
        .dot-purple { background-color: #BA68C8; }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid var(--accent-primary);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .loading-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex; justify-content: center; align-items: center;
            z-index: 9999;
        }
        .custom-btn {
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .custom-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
    </style>
</head>
<body class="text-gray-800">

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay hidden">
        <div class="loader"></div>
    </div>

    <!-- Auth Screens Container -->
    <div id="authContainer">
        <!-- Sign In Screen -->
        <div id="signInScreen" class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8" style="background-color: var(--bg-main);">
            <div class="max-w-md w-full space-y-8 bg-white/50 p-10 rounded-lg shadow-lg" style="background-color: #FFF9E5; border: 1px solid #DCD0A8;">
                <div>
                    <h2 class="mt-6 text-center text-3xl font-extrabold main-heading" style="color: var(--text-main);">Sign in to your account</h2>
                </div>
                <div id="setup-message" class="hidden text-center p-4 bg-yellow-100 border border-yellow-400 text-yellow-700 rounded-md">
                    <h3 class="font-bold">Configuration Needed</h3>
                    <p>Please update the <code>SUPABASE_URL</code> and <code>SUPABASE_ANON_KEY</code> variables in the script.</p>
                </div>
                <form id="signInForm" class="mt-8 space-y-6">
                    <div class="rounded-md shadow-sm -space-y-px">
                        <input id="signInEmail" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border placeholder-gray-500 rounded-t-md focus:outline-none sm:text-sm" placeholder="Email address" style="background-color: var(--bg-main); border-color: var(--bg-card); color: var(--text-main);">
                        <input id="signInPassword" name="password" type="password" autocomplete="current-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border placeholder-gray-500 rounded-b-md focus:outline-none sm:text-sm" placeholder="Password" style="background-color: var(--bg-main); border-color: var(--bg-card); color: var(--text-main);">
                    </div>
                    <div id="signInError" class="text-red-500 text-sm text-center"></div>
                    <div class="flex flex-col space-y-4">
                        <button type="submit" class="custom-btn group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white focus:outline-none focus:ring-2 focus:ring-offset-2" style="background-color: var(--accent-primary);">Sign In</button>
                        <p class="text-center text-sm" style="color: var(--text-main);">No account? <a href="#" id="showSignUpBtn" class="font-medium hover:underline" style="color: var(--accent-primary);">Create new account</a></p>
                    </div>
                </form>
            </div>
        </div>
        <!-- Sign Up Screen -->
        <div id="signUpScreen" class="hidden min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8" style="background-color: var(--bg-main);">
            <div class="max-w-md w-full space-y-8 bg-white/50 p-10 rounded-lg shadow-lg" style="background-color: #FFF9E5; border: 1px solid #DCD0A8;">
                <div><h2 class="mt-6 text-center text-3xl font-extrabold main-heading" style="color: var(--text-main);">Create your account</h2></div>
                <form id="signUpForm" class="mt-8 space-y-6">
                    <div class="rounded-md shadow-sm -space-y-px">
                        <input id="fullName" name="fullName" type="text" required class="appearance-none rounded-none relative block w-full px-3 py-2 border placeholder-gray-500 rounded-t-md focus:outline-none sm:text-sm" placeholder="Full Name" style="background-color: var(--bg-main); border-color: var(--bg-card); color: var(--text-main);">
                        <input id="username" name="username" type="text" required class="appearance-none rounded-none relative block w-full px-3 py-2 border placeholder-gray-500 focus:outline-none sm:text-sm" placeholder="Username (must be unique)" style="background-color: var(--bg-main); border-color: var(--bg-card); color: var(--text-main);">
                        <input id="signUpEmail" name="email" type="email" autocomplete="email" required class="appearance-none rounded-none relative block w-full px-3 py-2 border placeholder-gray-500 focus:outline-none sm:text-sm" placeholder="Email address" style="background-color: var(--bg-main); border-color: var(--bg-card); color: var(--text-main);">
                        <input id="signUpPassword" name="password" type="password" autocomplete="new-password" required class="appearance-none rounded-none relative block w-full px-3 py-2 border placeholder-gray-500 rounded-b-md focus:outline-none sm:text-sm" placeholder="Password" style="background-color: var(--bg-main); border-color: var(--bg-card); color: var(--text-main);">
                    </div>
                    <div id="signUpError" class="text-red-500 text-sm text-center"></div>
                    <div class="flex flex-col space-y-4">
                        <button type="submit" class="custom-btn group relative w-full flex justify-center py-2 px-4 border border-transparent text-sm font-medium rounded-md text-white focus:outline-none focus:ring-2 focus:ring-offset-2" style="background-color: var(--accent-primary);">Create Account</button>
                        <p class="text-center text-sm" style="color: var(--text-main);">Already have an account? <a href="#" id="showSignInBtn" class="font-medium hover:underline" style="color: var(--accent-primary);">Sign In</a></p>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Main App Content (hidden by default) -->
    <div id="app" class="hidden">
        <div class="flex-1 flex flex-col">
            <header class="text-center p-4 md:p-8 flex justify-between items-center">
                <div class="w-1/3"></div>
                <h1 class="text-5xl font-bold flex-1 text-center main-heading" style="color: var(--text-main);">AI Prompts</h1>
                <div class="w-1/3 flex justify-end">
                    <button id="signOutBtn" class="custom-btn px-4 py-2 rounded-md text-sm font-semibold border" style="background-color: transparent; border-color: #c53030; color: #c53030;">Sign Out</button>
                </div>
            </header>

            <main class="flex-1 p-4 md:p-8">
                <div id="db-error" class="hidden text-center p-4 my-4 rounded-md" style="background-color: #f8d7da; border-color: #f5c6cb; color: #721c24;">
                    <h3 class="font-bold">Database Setup Incomplete</h3>
                    <p>The application can't find the necessary database tables. Please run the full SQL setup script from the code comments in your Supabase project's SQL Editor to create the 'prompts' and 'profiles' tables.</p>
                </div>

                <div id="formWrapper" class="max-w-2xl mx-auto p-6 rounded-lg shadow-md mb-8 hidden" style="background-color: var(--bg-card);">
                     <h2 id="formTitle" class="text-2xl font-semibold mb-4 main-heading" style="color: var(--text-main);">Add New Prompt</h2>
                     <form id="promptForm">
                         <input type="hidden" id="promptId">
                         <div class="mb-4">
                             <label for="promptTitle" class="block text-sm font-medium mb-1" style="color: var(--text-main);">Title</label>
                             <input type="text" id="promptTitle" class="w-full px-3 py-2 border rounded-md focus:outline-none" required style="background-color: var(--bg-main); border-color: var(--accent-primary); color: var(--text-main);">
                         </div>
                         <div class="mb-4">
                             <div class="flex justify-between items-center mb-1">
                                 <label for="promptText" class="block text-sm font-medium" style="color: var(--text-main);">Prompt</label>
                                 <button type="button" id="enhanceBtn" class="text-sm px-3 py-1 text-white rounded-md custom-btn" style="background-color: var(--accent-secondary);">✨ Enhance</button>
                             </div>
                             <textarea id="promptText" rows="4" class="w-full px-3 py-2 border rounded-md focus:outline-none" required style="background-color: var(--bg-main); border-color: var(--accent-primary); color: var(--text-main);"></textarea>
                         </div>
                         <div class="mb-4">
                             <label class="block text-sm font-medium mb-2" style="color: var(--text-main);">Color Category</label>
                             <div id="colorSelector" class="flex space-x-3">
                                 <div class="color-dot dot-red" data-color="red"></div>
                                 <div class="color-dot dot-blue" data-color="blue"></div>
                                 <div class="color-dot dot-green" data-color="green"></div>
                                 <div class="color-dot dot-yellow" data-color="yellow"></div>
                                 <div class="color-dot dot-purple" data-color="purple"></div>
                             </div>
                         </div>
                         <div class="flex justify-end space-x-3">
                             <button type="button" id="cancelEdit" class="px-4 py-2 rounded-md" style="background-color: #DCD0A8; color: var(--text-main);">Cancel</button>
                             <button type="submit" id="submitButton" class="custom-btn px-4 py-2 text-white rounded-md" style="background-color: var(--accent-primary);">Add Prompt</button>
                         </div>
                     </form>
                </div>
                
                <div id="promptsContainer">
                    <div class="flex justify-between items-center mb-4 gap-4">
                        <div class="relative flex-grow">
                            <input type="search" id="searchInput" placeholder="Search by title..." class="w-full pl-10 pr-4 py-2 border rounded-md" style="background-color: var(--bg-main); border-color: var(--accent-primary); color: var(--text-main);">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-5 w-5" style="color: var(--text-main);" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                                    <path fill-rule="evenodd" d="M8 4a4 4 0 100 8 4 4 0 000-8zM2 8a6 6 0 1110.89 3.476l4.817 4.817a1 1 0 01-1.414 1.414l-4.816-4.816A6 6 0 012 8z" clip-rule="evenodd" />
                                </svg>
                            </div>
                        </div>
                        <button id="generateIdeasBtn" class="custom-btn px-4 py-2 text-white rounded-md flex-shrink-0" style="background-image: linear-gradient(to right, var(--accent-primary), #3a7a6a);">✨ Generate Ideas</button>
                    </div>
                    <!-- Prompt List -->
                    <div id="promptList" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                        <!-- Prompts will be injected here -->
                    </div>
                </div>
            </main>
        </div>
        <button id="addPromptBtn" class="fixed bottom-8 right-8 text-white w-16 h-16 rounded-full flex items-center justify-center text-4xl font-light shadow-lg custom-btn" style="background-color: var(--accent-primary);">
            +
        </button>
    </div>

    <script>
        // --- SUPABASE & AUTH SETUP ---
        const SUPABASE_URL = 'https://uahvnmkecryphlnrgeyo.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVhaHZubWtlY3J5cGhsbnJnZXlvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTIzMDkyMzEsImV4cCI6MjA2Nzg4NTIzMX0.BcP3PhxE5U2ekAeHuy2mBA_EfV94sKj1S2E3YfRdzFA';
        
        // --- Element Selection ---
        const appScreen = document.getElementById('app');
        const authContainer = document.getElementById('authContainer');
        const signInScreen = document.getElementById('signInScreen');
        const signUpScreen = document.getElementById('signUpScreen');
        const signInForm = document.getElementById('signInForm');
        const signUpForm = document.getElementById('signUpForm');
        const signInError = document.getElementById('signInError');
        const signUpError = document.getElementById('signUpError');
        const setupMessage = document.getElementById('setup-message');
        const showSignUpBtn = document.getElementById('showSignUpBtn');
        const showSignInBtn = document.getElementById('showSignInBtn');
        const signOutBtn = document.getElementById('signOutBtn');
        const dbError = document.getElementById('db-error');
        const promptsContainer = document.getElementById('promptsContainer');
        const promptList = document.getElementById('promptList');
        const searchInput = document.getElementById('searchInput');
        
        const promptForm = document.getElementById('promptForm');
        const promptIdInput = document.getElementById('promptId');
        const promptTitleInput = document.getElementById('promptTitle');
        const promptTextInput = document.getElementById('promptText');
        const colorSelector = document.getElementById('colorSelector');
        const submitButton = document.getElementById('submitButton');
        const cancelEditButton = document.getElementById('cancelEdit');
        const formWrapper = document.getElementById('formWrapper');
        const addPromptBtn = document.getElementById('addPromptBtn');
        const enhanceBtn = document.getElementById('enhanceBtn');
        const generateIdeasBtn = document.getElementById('generateIdeasBtn');
        const loadingOverlay = document.getElementById('loadingOverlay');
        const formTitle = document.getElementById('formTitle');

        // --- State ---
        let prompts = [];
        let selectedColor = 'red';
        let user = null;
        let dbClient = null;

        // --- Auth Functions ---
        async function handleSignUp(fullName, username, email, password) {
            loadingOverlay.classList.remove('hidden');
            signUpError.textContent = '';
            
            const { data, error } = await dbClient.auth.signUp({
                email,
                password,
                options: {
                    data: {
                        full_name: fullName,
                        username: username
                    }
                }
            });

            if (error) {
                signUpError.textContent = error.message;
                 if (error.message.includes('duplicate key value violates unique constraint "profiles_username_key"')) {
                    signUpError.textContent = 'This username is already taken. Please choose another one.';
                }
            } else {
                signUpError.textContent = 'Success! Please check your email to verify your account.';
                signUpForm.reset();
            }
            loadingOverlay.classList.add('hidden');
        }

        async function handleSignIn(email, password) {
            loadingOverlay.classList.remove('hidden');
            signInError.textContent = '';
            const { error } = await dbClient.auth.signInWithPassword({ email, password });
            if (error) signInError.textContent = error.message;
            loadingOverlay.classList.add('hidden');
        }
        
        async function handleSignOut() {
            await dbClient.auth.signOut();
        }

        // --- UI Navigation ---
        function showSignUpPage() {
            signInScreen.classList.add('hidden');
            signUpScreen.classList.remove('hidden');
        }

        function showSignInPage() {
            signUpScreen.classList.add('hidden');
            signInScreen.classList.remove('hidden');
        }

        // --- Gemini API ---
        const API_KEY = "";
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${API_KEY}`;
        
        async function callGemini(prompt) {
            loadingOverlay.classList.remove('hidden');
            try {
                const payload = { contents: [{ parts: [{ text: prompt }] }] };
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });
                if (!response.ok) throw new Error(`API Error: ${response.statusText}`);
                const data = await response.json();
                return data.candidates?.[0]?.content?.parts?.[0]?.text || "Sorry, I couldn't generate a response.";
            } catch (error) {
                console.error("Gemini API call failed:", error);
            } finally {
                loadingOverlay.classList.add('hidden');
            }
        }

        async function handleEnhancePrompt() {
            const currentText = promptTextInput.value;
            if (!currentText.trim()) {
                promptTextInput.focus();
                return;
            }
            
            enhanceBtn.disabled = true;
            enhanceBtn.innerHTML = 'Enhancing...';

            const prompt = `Enhance the following prompt to be more detailed, creative, and effective. Return only the enhanced prompt text, without any introductory phrases: "${currentText}"`;
            const enhancedText = await callGemini(prompt);
            
            if (enhancedText) {
                promptTextInput.value = enhancedText;
            } else {
                console.error("Enhance feature failed to get a response from the AI.");
            }
            
            enhanceBtn.disabled = false;
            enhanceBtn.innerHTML = '✨ Enhance';
        }

        async function handleGenerateIdeas() {
            generateIdeasBtn.disabled = true;
            generateIdeasBtn.innerHTML = 'Generating...';
            
            const metaPrompt = `Generate 3 diverse and practical prompt ideas for real-world use cases. Examples: marketing campaign, summarizing a document, creative writing starter. For each idea, provide a title and the prompt text. Format the response as a valid JSON array of objects, where each object has a 'title' and a 'text' key.`;
            const resultText = await callGemini(metaPrompt);

            if (resultText) {
                try {
                    const jsonString = resultText.replace(/```json/g, '').replace(/```/g, '').trim();
                    const newIdeas = JSON.parse(jsonString);
                    const newPrompts = newIdeas.map(idea => ({
                        title: idea.title,
                        text: idea.text,
                        color: 'purple',
                        user_id: user.id
                    }));
                    const { error } = await dbClient.from('prompts').insert(newPrompts);
                    if (error) throw error;
                    await fetchPrompts();
                } catch (error) {
                    console.error("Failed to parse or save AI-generated ideas:", error);
                }
            }

            generateIdeasBtn.disabled = false;
            generateIdeasBtn.innerHTML = '✨ Generate Ideas';
        }

        // --- Database (CRUD) Functions ---
        async function fetchPrompts() {
            if (!user) return;
            dbError.classList.add('hidden');
            promptsContainer.classList.remove('hidden');
            addPromptBtn.classList.remove('hidden');
            loadingOverlay.classList.remove('hidden');
            const { data, error } = await dbClient.from('prompts').select('*').eq('user_id', user.id);
            
            if (error) {
                console.error('Error fetching prompts:', error);
                if (error.code === '42P01') {
                    console.error("DATABASE SETUP ERROR: The 'prompts' table was not found.");
                    dbError.innerHTML = `<h3 class="font-bold">Database Setup Incomplete</h3><p>The 'prompts' table is missing. Please run the full SQL setup script from the code comments in your Supabase project's SQL Editor.</p>`;
                    dbError.classList.remove('hidden');
                    promptsContainer.classList.add('hidden');
                    addPromptBtn.classList.add('hidden');
                }
            } else {
                prompts = data;
                renderPrompts();
            }
            loadingOverlay.classList.add('hidden');
        }

        // --- UI Functions ---
        function showForm(isEditing = false) {
            formTitle.textContent = isEditing ? 'Edit Prompt' : 'Add New Prompt';
            formWrapper.classList.remove('hidden');
            addPromptBtn.classList.add('hidden');
            window.scrollTo(0, 0);
        }

        function hideForm() {
            formWrapper.classList.add('hidden');
            addPromptBtn.classList.remove('hidden');
        }

        function clearForm() {
            promptForm.reset();
            promptIdInput.value = '';
            submitButton.textContent = 'Add Prompt';
            selectedColor = 'red';
            document.querySelectorAll('.color-dot').forEach(dot => dot.classList.remove('selected'));
            document.querySelector('.dot-red').classList.add('selected');
        }

        // --- Core App Logic ---
        function renderPrompts() {
            promptList.innerHTML = '';

            const searchTerm = searchInput.value.toLowerCase();
            const filteredPrompts = prompts.filter(prompt => 
                prompt.title.toLowerCase().includes(searchTerm)
            );

            if (filteredPrompts.length === 0) {
                 promptList.innerHTML = `<p class="text-center text-lg p-8 col-span-full" style="color: var(--text-main); opacity: 0.7;">No prompts found.</p>`;
                 return;
            }

            filteredPrompts.forEach(prompt => {
                const card = document.createElement('div');
                card.className = `prompt-card p-4 rounded-lg flex flex-col justify-between color-${prompt.color}`;
                card.dataset.id = prompt.id;
                card.innerHTML = `
                    <div>
                        <h3 class="font-bold text-lg" style="color: var(--text-main);">${prompt.title}</h3>
                        <p class="my-2 prompt-text text-sm">${prompt.text}</p>
                    </div>
                    <div class="flex justify-between items-center mt-2">
                        <button class="copy-btn flex items-center text-sm px-3 py-1 rounded custom-btn" style="background-color: var(--accent-primary); color: white;">
                            <svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>
                            Copy
                        </button>
                       <div class="flex space-x-1">
                            <button class="edit-btn p-1 rounded-full hover:bg-black/10" style="color: var(--text-main);">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path d="M17.414 2.586a2 2 0 00-2.828 0L7 10.172V13h2.828l7.586-7.586a2 2 0 000-2.828z" /><path fill-rule="evenodd" d="M2 6a2 2 0 012-2h4a1 1 0 010 2H4v10h10v-4a1 1 0 112 0v4a2 2 0 01-2 2H4a2 2 0 01-2-2V6z" clip-rule="evenodd" /></svg>
                            </button>
                            <button class="delete-btn p-1 rounded-full hover:bg-black/10" style="color: var(--text-main);">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                    </div>
                `;
                promptList.appendChild(card);
            });
        }

        async function handleFormSubmit(e) {
            e.preventDefault();
            const id = promptIdInput.value;
            const title = promptTitleInput.value.trim();
            const text = promptTextInput.value.trim();
            const promptData = { title, text, color: selectedColor, user_id: user.id };
            let error;
            if (id) {
                ({ error } = await dbClient.from('prompts').update(promptData).eq('id', id));
            } else {
                ({ error } = await dbClient.from('prompts').insert(promptData));
            }
            if (error) {
                console.error('Error saving prompt:', error.message);
            } else {
                await fetchPrompts();
                hideForm();
            }
        }

        function editPrompt(id) {
            const prompt = prompts.find(p => p.id == id);
            if (prompt) {
                clearForm();
                promptIdInput.value = prompt.id;
                promptTitleInput.value = prompt.title;
                promptTextInput.value = prompt.text;
                selectedColor = prompt.color;
                document.querySelectorAll('.color-dot').forEach(dot => {
                    dot.classList.toggle('selected', dot.dataset.color === selectedColor);
                });
                submitButton.textContent = 'Update Prompt';
                showForm(true);
            }
        }

        async function deletePrompt(id) {
            const { error } = await dbClient.from('prompts').delete().eq('id', id);
            if (error) {
                console.error('Error deleting prompt:', error.message);
            } else {
                if (!formWrapper.classList.contains('hidden') && promptIdInput.value == id) {
                    hideForm();
                }
                await fetchPrompts();
            }
        }

        function copyPromptText(id, button) {
            const prompt = prompts.find(p => p.id == id);
            if (!prompt) return;

            const textArea = document.createElement("textarea");
            textArea.value = prompt.text;
            textArea.style.position = "fixed"; 
            textArea.style.left = "-9999px";
            document.body.appendChild(textArea);
            textArea.focus();
            textArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    button.innerHTML = 'Copied!';
                    setTimeout(() => {
                        button.innerHTML = `<svg class="w-4 h-4 mr-2" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg> Copy`;
                    }, 2000);
                } else {
                     console.error('Fallback: Oops, unable to copy');
                }
            } catch (err) {
                console.error('Fallback: Oops, unable to copy', err);
            }

            document.body.removeChild(textArea);
        }

        // --- Event Listeners ---
        function setupEventListeners() {
            signInForm.addEventListener('submit', (e) => { e.preventDefault(); handleSignIn(signInForm.email.value, signInForm.password.value); });
            signUpForm.addEventListener('submit', (e) => { e.preventDefault(); handleSignUp(signUpForm.fullName.value, signUpForm.username.value, signUpForm.email.value, signUpForm.password.value); });
            showSignUpBtn.addEventListener('click', (e) => { e.preventDefault(); showSignUpPage(); });
            showSignInBtn.addEventListener('click', (e) => { e.preventDefault(); showSignInPage(); });
            signOutBtn.addEventListener('click', handleSignOut);
            addPromptBtn.addEventListener('click', () => { clearForm(); showForm(); });
            cancelEditButton.addEventListener('click', () => { hideForm(); });
            promptForm.addEventListener('submit', handleFormSubmit);
            enhanceBtn.addEventListener('click', handleEnhancePrompt);
            generateIdeasBtn.addEventListener('click', handleGenerateIdeas);
            searchInput.addEventListener('input', renderPrompts);
            colorSelector.addEventListener('click', (e) => { if (e.target.classList.contains('color-dot')) { document.querySelectorAll('.color-dot').forEach(dot => dot.classList.remove('selected')); e.target.classList.add('selected'); selectedColor = e.target.dataset.color; } });
            promptList.addEventListener('click', (e) => { const card = e.target.closest('.prompt-card'); if (!card) return; const id = card.dataset.id; if (e.target.closest('.edit-btn')) editPrompt(id); if (e.target.closest('.delete-btn')) deletePrompt(id); if (e.target.closest('.copy-btn')) copyPromptText(id, e.target.closest('.copy-btn')); });
        }

        // --- PWA Asset Generation ---
        function generatePwaAssets() {
            const manifest = {
                "name": "AI Prompt Manager",
                "short_name": "AI Prompts",
                "start_url": ".",
                "display": "standalone",
                "background_color": "#FFF9E5",
                "theme_color": "#4A9782",
                "description": "An AI-powered PWA to manage your prompts.",
                "icons": [
                    { "src": "icon-192x192.png", "sizes": "192x192", "type": "image/png" },
                    { "src": "icon-512x512.png", "sizes": "512x512", "type": "image/png" }
                ]
            };
            function createIcon(size, color) {
                const canvas = document.createElement('canvas');
                canvas.width = size;
                canvas.height = size;
                const ctx = canvas.getContext('2d');
                ctx.fillStyle = color;
                ctx.fillRect(0, 0, size, size);
                ctx.fillStyle = 'white';
                ctx.font = `${size * 0.6}px Inter, sans-serif`;
                ctx.textAlign = 'center';
                ctx.textBaseline = 'middle';
                ctx.fillText('AI', size / 2, size / 2);
                return canvas.toDataURL();
            }
            
            const icon192 = createIcon(192, '#4A9782');
            const icon512 = createIcon(512, '#4A9782');

            manifest.icons[0].src = icon192;
            manifest.icons[1].src = icon512;

            const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            const manifestURL = URL.createObjectURL(manifestBlob);
            
            const head = document.querySelector('head');
            
            const manifestLink = document.createElement('link');
            manifestLink.rel = 'manifest';
            manifestLink.href = manifestURL;
            head.appendChild(manifestLink);

            const appleIconLink = document.createElement('link');
            appleIconLink.rel = 'apple-touch-icon';
            appleIconLink.href = icon192;
            head.appendChild(appleIconLink);
        }


        // --- App Initialization ---
        function initializeApp() {
            if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
                signInForm.parentElement.classList.add('hidden');
                setupMessage.classList.remove('hidden');
                return;
            }
            const { createClient } = supabase;
            dbClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
            setupEventListeners();
            dbClient.auth.onAuthStateChange((event, session) => {
                if (session) {
                    user = session.user;
                    authContainer.classList.add('hidden');
                    appScreen.classList.remove('hidden');
                    fetchPrompts();
                } else {
                    user = null;
                    prompts = [];
                    authContainer.classList.remove('hidden');
                    showSignInPage();
                    appScreen.classList.add('hidden');
                }
            });
            generatePwaAssets();
            clearForm();
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeApp();
        });
    </script>
</body>
</html>
